# name: Deploy to Alibaba ECS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: SSH into ECS and deploy
#         uses: appleboy/ssh-action@v1.0.3
#         with:
#           host: ${{ secrets.ECS_HOST }}
#           username: ${{ secrets.ECS_USER }}
#           key: ${{ secrets.ECS_SSH_KEY }}
#           port: 27
#           script: |
#             echo "ğŸš€ Starting deployment on ECS..."
#             cd /root/jopa-sales-server
#             git pull origin main
#             docker system prune -af
#             docker-compose down
#             docker-compose build --no-cache
#             docker-compose up -d
#             docker exec jopa-backend-api npx prisma migrate deploy
#             echo "âœ… Deployment complete!"
name: Deploy to Alibaba ECS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout the repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ SSH into ECS and deploy
      - name: SSH into ECS and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          port: 27   # Custom SSH port
          script: |
            set -e  # Exit immediately if a command fails
            echo "ğŸš€ Starting deployment on ECS..."

            # 1. Verify directory
            if [ ! -d "/root/jopa-sales-server" ]; then
              echo "âŒ Directory /root/jopa-sales-server not found"
              exit 1
            fi
            cd /root/jopa-sales-server

            # 2. Pull latest code
            echo "ğŸ“¥ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            # 3. Stop existing containers safely
            echo "ğŸ›‘ Stopping existing containers..."
            docker-compose down --remove-orphans

            # 4. Build updated containers
            echo "ğŸ—ï¸ Building Docker containers..."
            docker-compose build --no-cache

            # 5. Start containers
            echo "â–¶ï¸ Starting containers..."
            docker-compose up -d

            # 6. Run Prisma migrations safely
            echo "ğŸ“¦ Running Prisma migrations..."
            docker-compose run --rm jopa-backend-api npx prisma migrate deploy

            # 7. Verify containers
            echo "âœ… Containers running:"
            docker ps

            echo "ğŸ‰ Deployment complete!"
